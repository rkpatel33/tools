<!DOCTYPE html>
<html>
<head>
    <title>OpenCV Test</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: monospace; padding: 20px; background: #111; color: #0f0; }
        #log { white-space: pre-wrap; font-size: 12px; margin-bottom: 20px; }
        .error { color: #f00; }
        .success { color: #0f0; }
        .info { color: #0ff; }
        #testImage { max-width: 200px; margin: 10px 0; }
        #outputCanvas { max-width: 200px; margin: 10px 0; border: 1px solid #0f0; }
    </style>
</head>
<body>
    <h2>OpenCV.js Loading Test</h2>
    <div id="log"></div>

    <h3>Test Image</h3>
    <img id="testImage" crossorigin="anonymous" src="https://picsum.photos/400/300" alt="Test">
    <canvas id="outputCanvas"></canvas>

    <script>
        const log = document.getElementById('log');
        function addLog(msg, type = 'info') {
            const line = document.createElement('div');
            line.className = type;
            line.textContent = `[${new Date().toISOString().slice(11,23)}] ${msg}`;
            log.appendChild(line);
            log.scrollTop = log.scrollHeight;
            console.log(msg);
        }

        addLog('Page loaded, setting up OpenCV callbacks FIRST...');

        const startTime = performance.now();
        let cvReady = false;

        // CRITICAL: Set up cv object with onRuntimeInitialized BEFORE loading script
        // This is the correct pattern for OpenCV.js
        window.cv = {
            onRuntimeInitialized: function() {
                if (cvReady) return;
                cvReady = true;
                const elapsed = ((performance.now() - startTime) / 1000).toFixed(2);
                addLog(`SUCCESS: cv.onRuntimeInitialized (${elapsed}s)`, 'success');
                testOpenCV();
            }
        };
        addLog('Pre-created cv object with onRuntimeInitialized');

        // Also set global callback as fallback
        window.onOpenCvReady = function() {
            if (cvReady) return;
            cvReady = true;
            const elapsed = ((performance.now() - startTime) / 1000).toFixed(2);
            addLog(`SUCCESS: onOpenCvReady global (${elapsed}s)`, 'success');
            testOpenCV();
        };
        addLog('Set window.onOpenCvReady callback');

        // Also set Module callback (Emscripten pattern)
        window.Module = {
            onRuntimeInitialized: function() {
                if (cvReady) return;
                cvReady = true;
                const elapsed = ((performance.now() - startTime) / 1000).toFixed(2);
                addLog(`SUCCESS: Module.onRuntimeInitialized (${elapsed}s)`, 'success');
                testOpenCV();
            }
        };
        addLog('Set Module.onRuntimeInitialized callback');

        // NOW load the script
        addLog('Loading OpenCV.js from docs.opencv.org...');
        const script = document.createElement('script');
        script.src = 'https://docs.opencv.org/4.9.0/opencv.js';
        script.async = true;

        script.onload = function() {
            const elapsed = ((performance.now() - startTime) / 1000).toFixed(2);
            addLog(`Script onload fired (${elapsed}s)`);

            if (typeof cv !== 'undefined') {
                addLog('cv object exists');
                addLog(`cv keys: ${Object.keys(cv).slice(0,10).join(', ')}...`);

                if (cv.Mat) {
                    if (!cvReady) {
                        cvReady = true;
                        addLog('cv.Mat exists - already initialized!', 'success');
                        testOpenCV();
                    }
                } else {
                    addLog('cv.Mat not yet available, waiting...');
                }
            } else {
                addLog('cv is undefined after script load', 'error');
            }
        };

        script.onerror = function(e) {
            const elapsed = ((performance.now() - startTime) / 1000).toFixed(2);
            addLog(`FAILED: Script load error (${elapsed}s)`, 'error');
        };

        window.addEventListener('error', function(e) {
            addLog(`Global error: ${e.message}`, 'error');
            if (e.filename) {
                addLog(`File: ${e.filename}:${e.lineno}`, 'error');
            }
        });

        document.head.appendChild(script);
        addLog('Script element added, waiting...');

        // Poll for cv.Mat as ultimate fallback
        let pollCount = 0;
        const pollInterval = setInterval(function() {
            if (cvReady) {
                clearInterval(pollInterval);
                return;
            }
            pollCount++;
            const elapsed = ((performance.now() - startTime) / 1000).toFixed(1);

            if (typeof cv !== 'undefined' && cv.Mat) {
                clearInterval(pollInterval);
                cvReady = true;
                addLog(`SUCCESS: cv.Mat found by polling (${elapsed}s)`, 'success');
                testOpenCV();
                return;
            }

            if (pollCount % 5 === 0) { // Log every 2.5 seconds
                if (typeof cv === 'undefined') {
                    addLog(`Polling ${elapsed}s - cv undefined`);
                } else {
                    addLog(`Polling ${elapsed}s - cv exists, Mat: ${!!cv.Mat}`);
                }
            }

            if (pollCount > 120) { // 60 seconds
                addLog('TIMEOUT: 60 seconds, cv.Mat never became available', 'error');
                if (typeof cv !== 'undefined') {
                    addLog(`Final cv keys: ${Object.keys(cv).join(', ')}`, 'error');
                }
                clearInterval(pollInterval);
            }
        }, 500);

        function testOpenCV() {
            try {
                addLog('Testing cv.Mat creation...');
                const mat = new cv.Mat();
                addLog(`Mat created: ${mat.rows}x${mat.cols}`, 'success');
                mat.delete();
                addLog('Mat deleted successfully', 'success');

                const img = document.getElementById('testImage');
                if (img.complete && img.naturalWidth > 0) {
                    processImage(img);
                } else {
                    addLog('Waiting for test image to load...');
                    img.onload = () => processImage(img);
                }

                addLog('=== OpenCV IS WORKING ===', 'success');
            } catch(e) {
                addLog(`Test failed: ${e.message}`, 'error');
                addLog(e.stack, 'error');
            }
        }

        function processImage(img) {
            try {
                addLog('Processing test image...');
                const canvas = document.createElement('canvas');
                canvas.width = img.naturalWidth;
                canvas.height = img.naturalHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);

                addLog(`Image size: ${canvas.width}x${canvas.height}`);

                const src = cv.imread(canvas);
                addLog(`cv.imread done: ${src.rows}x${src.cols}`);

                const gray = new cv.Mat();
                cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
                addLog('Converted to grayscale');

                const edges = new cv.Mat();
                cv.Canny(gray, edges, 50, 150);
                addLog('Applied Canny edge detection');

                const outputCanvas = document.getElementById('outputCanvas');
                cv.imshow(outputCanvas, edges);
                addLog('Output displayed on canvas', 'success');

                src.delete();
                gray.delete();
                edges.delete();
                addLog('=== IMAGE PROCESSING COMPLETE ===', 'success');
            } catch(e) {
                addLog(`Image processing failed: ${e.message}`, 'error');
            }
        }
    </script>
</body>
</html>
